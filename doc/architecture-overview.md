# Архитектура расширения Claude Code AgentAPI

## Схема взаимодействия

```
┌─────────────────────────────────────────────────────────────────┐
│                      VS Code Extension                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Commands      │  │   WebView       │  │   Polling       │  │
│  │   - Start       │  │   - Chat UI     │  │   - Messages    │  │
│  │   - Stop        │  │   - Input       │  │   - Status      │  │
│  │   - Chat        │  │   - Display     │  │   - Updates     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                              │                        │         │
│                              │ HTTP Requests          │         │
│                              ▼                        │         │
├─────────────────────────────────────────────────────────────────┤
│                      AgentAPI Server                           │
│                     (localhost:3284)                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ Terminal        │  │ HTTP Endpoints  │  │ Message Parser  │  │
│  │ Emulator        │  │ /status         │  │ - User input    │  │
│  │ - PTY           │  │ /messages       │  │ - Agent output  │  │
│  │ - Keystrokes    │  │ /message        │  │ - TUI cleanup   │  │
│  │ - Screen parse  │  │ /events         │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                              │                                 │
│                              │ Terminal I/O                    │
│                              ▼                                 │
├─────────────────────────────────────────────────────────────────┤
│                      Claude Code CLI                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ Text Interface  │  │ File System     │  │ Git Integration │  │
│  │ - Interactive   │  │ - Read/Write    │  │ - Commits       │  │
│  │ - Commands      │  │ - Directory     │  │ - Branches      │  │
│  │ - Responses     │  │ - Permissions   │  │ - History       │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                              │                                 │
│                              │ HTTPS API                       │
│                              ▼                                 │
├─────────────────────────────────────────────────────────────────┤
│                      Anthropic API                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ Claude Models   │  │ Authentication  │  │ Rate Limiting   │  │
│  │ - Sonnet 4      │  │ - API Keys      │  │ - Tokens        │  │
│  │ - Opus 4        │  │ - OAuth         │  │ - Requests      │  │
│  │ - Haiku 3.5     │  │ - Billing       │  │ - Quotas        │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## Компоненты расширения

### 1. Extension.ts - Основной модуль

**Активация:**
- Регистрация команд в VS Code
- Настройка контекста расширения
- Инициализация переменных состояния

**Управление сервером:**
- Запуск/остановка AgentAPI процесса
- Мониторинг состояния сервера
- Обработка ошибок запуска

**Webview панель:**
- Создание пользовательского интерфейса
- Обработка сообщений от UI
- Управление жизненным циклом панели

### 2. HTTP API интеграция

**Axios клиент:**
- Отправка запросов к AgentAPI
- Обработка ответов и ошибок
- Автоматические повторы при сбоях

**Polling система:**
- Регулярные запросы обновлений
- Оптимизация частоты запросов
- Управление ресурсами

### 3. WebView интерфейс

**HTML структура:**
```html
<div class="chat-container">
  <!-- Область сообщений -->
</div>
<div class="input-container">
  <!-- Поле ввода и кнопка -->
</div>
```

**JavaScript функции:**
- `sendMessage()` - отправка сообщений
- `displayMessages()` - отображение истории
- `vscode.postMessage()` - связь с расширением

**CSS стили:**
- Использование CSS переменных VS Code
- Адаптивная верстка для разных размеров
- Темная/светлая тема поддержка

## Поток данных

### Отправка сообщения:
1. Пользователь вводит текст в WebView
2. JavaScript отправляет сообщение в extension.ts
3. Extension.ts делает POST к AgentAPI
4. AgentAPI передает ввод в Claude Code
5. Claude Code отправляет запрос к Anthropic API

### Получение ответа:
1. Anthropic API возвращает ответ Claude
2. Claude Code обрабатывает и отображает ответ
3. AgentAPI парсит вывод терминала
4. Polling получает обновления через GET /messages
5. WebView обновляет интерфейс

## Состояние системы

### Переменные состояния:
- `agentApiProcess` - процесс AgentAPI сервера
- `chatPanel` - ссылка на WebView панель
- `messagePolling` - интервал для polling

### Жизненный цикл:
1. **Активация:** Регистрация команд
2. **Запуск:** Создание процесса AgentAPI
3. **Работа:** Polling и обработка сообщений
4. **Деактивация:** Очистка ресурсов

## Обработка ошибок

### Сетевые ошибки:
- Повторные запросы при таймаутах
- Fallback на прямое управление CLI
- Уведомления пользователя

### Процесс ошибки:
- Автоматический перезапуск сервера
- Логирование в консоль VS Code
- Graceful shutdown при закрытии

### UI ошибки:
- Валидация ввода пользователя
- Показ статуса подключения
- Индикаторы загрузки

## Производительность

### Оптимизации:
- Lazy loading WebView контента
- Throttling для частых обновлений
- Кеширование состояния сообщений

### Мониторинг:
- Отслеживание использования памяти
- Контроль частоты HTTP запросов
- Профилирование WebView рендеринга

## Безопасность

### Аутентификация:
- Использование существующих credentials Claude
- Нет хранения API ключей в расширении
- Proxy через AgentAPI для безопасности

### Разрешения:
- Ограниченный доступ к файловой системе
- Работа в песочнице VS Code
- Контролируемое выполнение команд

## Совместимость

### Платформы:
- macOS (основная поддержка)
- Linux (через AgentAPI)
- Windows (WSL требуется)

### Версии:
- VS Code 1.75+
- Node.js 18+
- Claude Code 1.0+
- AgentAPI latest
