# База знаний: Динамическое изменение частоты polling для интерактивных сообщений

## Проблема
При работе с интерактивными сообщениями AgentAPI (выбор IDE, резюме сессий) отклик интерфейса был медленным из-за фиксированного интервала polling 1000ms. Пользователь нажимал стрелки навигации, но изменения отображались только через 1+ секунду.

## Решение
Реализована система динамического изменения частоты polling:
- **Обычный режим**: 1000ms (для экономии ресурсов)
- **Интерактивный режим**: 75ms (для быстрого отклика)
- **Автоматическое переключение**: при обнаружении/исчезновении интерактивных элементов

## Расположение кода в проекте

### Основные файлы
- `src/extension.ts` - вся логика динамического polling
- `package.json` - версия расширения
- `CHANGELOG.md` - документирование изменений

### Ключевые места в коде

#### 1. Переменные состояния (строки 11-12)
```typescript
let currentPollingInterval = 1000; // Текущий интервал polling
let isInteractiveMode = false;      // Флаг интерактивного режима
```

#### 2. Функция детектирования (строки 16-25)
```typescript
function isInteractiveMessage(content: string): boolean {
    const interactiveHeaders = [
        "Select IDE",
        "Connect to an IDE for integrated development features", 
        "Modified    Created     # Messages Summary",  // /resume команда
        "Resume Session"
    ];
    return interactiveHeaders.some(header => content.includes(header));
}
```

#### 3. Основная логика polling (строки 186-229)
```typescript
function startMessagePolling(): void {
    // Внутренняя функция pollMessages содержит логику:
    // 1. Получение сообщений от API
    // 2. Проверка последнего сообщения на интерактивность
    // 3. Переключение режимов при изменении состояния
    // 4. Перезапуск polling с новым интервалом
}
```

#### 4. Сброс состояния при остановке (строки 52-54)
```typescript
const stopCommand = vscode.commands.registerCommand('claude-code-agentapi.stop', () => {
    // ... существующий код ...
    isInteractiveMode = false;
    currentPollingInterval = 1000;
});
```

## Алгоритм работы

### Детектирование интерактивных сообщений
1. При каждом polling получаем список сообщений
2. Берем последнее сообщение с `role: 'agent'`
3. Проверяем содержимое на наличие известных заголовков
4. Сравниваем с предыдущим состоянием

### Переключение режимов
```typescript
if (nowInteractive \!== wasInteractive) {
    isInteractiveMode = nowInteractive;
    const newInterval = nowInteractive ? 75 : 1000;
    
    if (newInterval \!== currentPollingInterval) {
        currentPollingInterval = newInterval;
        // Перезапуск polling с новым интервалом
        if (messagePolling) clearInterval(messagePolling);
        messagePolling = setInterval(pollMessages, currentPollingInterval);
    }
}
```

## Как добавить новые интерактивные команды

### Шаг 1: Определить команду
1. Протестировать новую команду в AgentAPI
2. Выполнить команду и получить ответ
3. Проверить Raw Data Output для анализа структуры

### Шаг 2: Найти характерный заголовок
Интерактивные сообщения обычно содержат:
- Заголовок с описанием действия
- Список опций с номерами
- Инструкции "Enter to confirm · Esc to exit"
- Стрелку выбора "❯"

### Шаг 3: Добавить в детектирование
Добавить характерный заголовок в массив `interactiveHeaders`:
```typescript
const interactiveHeaders = [
    "Select IDE",
    "Connect to an IDE for integrated development features",
    "Modified    Created     # Messages Summary",
    "Resume Session",
    "НОВЫЙ_ЗАГОЛОВОК_ЗДЕСЬ"  // <-- добавить сюда
];
```

### Шаг 4: Протестировать
1. Пересобрать расширение: `npx vsce package`
2. Переустановить расширение
3. Протестировать команду
4. Убедиться, что режим переключается (проверить консоль)

## Примеры интерактивных сообщений

### Команда /ide
```json
{
    "content": "│  Select IDE  │\n│     1. Visual Studio Code     │\n│   ❯ 2. None✔     │\n Enter to confirm · Esc to exit",
    "role": "agent"
}
```
**Ключевой заголовок**: `"Select IDE"`

### Команда /resume  
```json
{
    "content": "    Modified    Created     # Messages Summary\n...",
    "role": "agent"
}
```
**Ключевой заголовок**: `"Modified    Created     # Messages Summary"`

## Отладка и диагностика

### Логирование переключений
В коде присутствует логирование:
```typescript
console.log(`Изменен интервал polling на ${currentPollingInterval}ms (интерактивный режим: ${isInteractiveMode})`);
```

### Проверка состояния
Можно добавить временное логирование для отладки:
```typescript
console.log('Checking message:', lastMessage.content.substring(0, 100));
console.log('Is interactive:', isInteractiveMessage(lastMessage.content));
```

## Производительность

### Метрики
- **Обычный режим**: 1 запрос/секунду
- **Интерактивный режим**: ~13.3 запроса/секунду  
- **Ускорение отклика**: в 13.3 раза

### Оптимизация
- Переключение происходит только при изменении состояния
- Нет постоянных высокочастотных запросов
- Автоматический возврат к экономному режиму

## Потенциальные проблемы

### 1. Ложные срабатывания
**Проблема**: Обычное сообщение содержит один из заголовков
**Решение**: Использовать более специфичные паттерны или regex

### 2. Новые интерактивные команды
**Проблема**: Появились новые команды, которые не детектируются
**Решение**: Добавить заголовки в список (см. "Как добавить новые команды")

### 3. Изменение формата сообщений
**Проблема**: AgentAPI изменил формат интерактивных сообщений
**Решение**: Обновить заголовки в `interactiveHeaders`

## История изменений
- **v0.3.3 (2025-07-16)**: Первая реализация динамического polling
- **Поддерживаемые команды**: /ide, /resume

## Рекомендации для развития

1. **Конфигурация**: Сделать интервалы настраиваемыми через settings.json
2. **Метрики**: Добавить счетчики переключений для мониторинга
3. **Regex**: Заменить строковый поиск на регулярные выражения
4. **API**: Использовать WebSocket или SSE для real-time обновлений
5. **Тестирование**: Автоматические тесты для новых интерактивных команд

## Заключение
Система динамического polling обеспечивает быстрый отклик при интерактивных сообщениях, сохраняя экономию ресурсов в обычном режиме. Легко расширяется для новых команд через добавление заголовков в массив `interactiveHeaders`.
EOF < /dev/null